<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DS61 Food Searcher</title>

    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/bootstrap-material-design/dist/css/bootstrap-material-design.min.css">
    <link rel="stylesheet" href="bower_components/bootstrap-material-design/dist/css/ripples.min.css">
    <!--<link rel="stylesheet" href="bower_components/jquery-ui/themes/base/jquery-ui.min.css">-->

    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <meta name="format-detection" content="telephone=no">

    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="import" href="bower_components/platinum-sw/platinum-sw-register.html">
    <link rel="import" href="bower_components/platinum-sw/platinum-sw-cache.html">
    <link rel="import" href="bower_components/platinum-sw/platinum-sw-offline-analytics.html">

    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/bootstrap-material-design/dist/js/material.min.js"></script>
    <script src="bower_components/bootstrap-material-design/dist/js/ripples.min.js"></script>

    <!--<script src="bower_components/jquery-ui/ui/core.js"></script>-->
    <!--<script src="bower_components/jquery-ui/ui/widget.js"></script>-->
    <!--<script src="bower_components/jquery-ui/ui/position.js"></script>-->
    <!--<script src="bower_components/jquery-ui/ui/menu.js"></script>-->
    <!--<script src="bower_components/jquery-ui/ui/autocomplete.js"></script>-->

    <script src="bower_components/react/react.min.js"></script>
    <script src="bower_components/react/react-dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>

    <script type="text/javascript" src="data/ds61_items_list.js"></script>
    <style type="text/css">
        .dropdown-menu {
            width: 100%;
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <!--<form action="">
        <div class="form-group label-floating">
            <label class="control-label" for="focusedInput1">Code</label>
            <input class="form-control" id="focusedInput1" autocomplete="off" type="tel" name="code" pattern="\d{3}"
                   maxlength="3">
        </div>
        <div class="form-group label-floating">
            <label class="control-label" for="focusedInput2">Title</label>
            <input class="form-control" id="focusedInput2" autocomplete="off" type="text" name="title">
            <div class="js-suggest-list-container"></div>
        </div>
    </form>-->
</div>

<platinum-sw-register auto-register>
    <platinum-sw-cache default-cache-strategy="networkFirst"></platinum-sw-cache>
    <platinum-sw-offline-analytics></platinum-sw-offline-analytics>
</platinum-sw-register>

<script type="text/babel">
    // todo use ReactCSSTransitionGroup
    // todo implement two way binding https://facebook.github.io/react/docs/two-way-binding-helpers.html
//    var LinkedStateMixin = require('react-addons-linked-state-mixin');

    var InputMixin = {
        getDefaultProps: function() {
            return {
                value: '',
                onChange: function(){}
            };
        },
        componentWillReceiveProps: function(nextProps) {
            if (this.props.value != nextProps.value) {
                this.setState({
                    value: nextProps.value
                });
            }
        },
        onChange: function(newValue) {
            this.props.onChange(newValue);
        }
    };
    var BootstrapInput = React.createClass({
        getDefaultProps: function() {
            return {
                id: '',
                value: '',
                type: 'text',
                pattern: '*',
                maxLength: 524288,
                onChange: function(){}
            };
        },
        componentDidUpdate: function() {
            this._input.dispatchEvent(new Event('change', {'bubbles': true}));
        },
        onChange: function(e) {
            this.props.onChange(e.target.value);
        },
        render: function() {
            var id = "focusedInput_" + this.props.id;
            return (
                <div className="form-group label-floating">
                    <label
                        className="control-label"
                        htmlFor={id}>{this.props.name}</label>
                    <input
                        onChange={this.onChange}
                        className="form-control"
                        id={id}
                        autoComplete="off"
                        type={this.props.type} name={this.props.name.toLowerCase()}
                        pattern={this.props.pattern}
                        maxLength={this.props.maxLength}
                        value={this.props.value}
                        ref={(ref) => this._input = ref}/>
                    {this.props.children}
                </div>
            )
        }
    });
    var Title = React.createClass({
        mixins: [InputMixin],
        render: function() {
            return (
                <BootstrapInput
                    onChange={this.onChange}
                    value={this.props.value}
                    name="Title"
                    id="title"
                    type="text">
                    {this.props.children}
                </BootstrapInput>
            )
        }
    });
    var Code = React.createClass({
        mixins: [InputMixin],
        render: function() {
            return (
                <BootstrapInput
                    onChange={this.onChange}
                    value={this.props.value}
                    name="Code"
                    id="code"
                    type="tel"
                    maxLength="3"
                    pattern="\d+" />
            )
        }
    });
    var SuggestBox = React.createClass({
        getDefaultProps: function() {
            return {
                data: [["000", "food"], ["001", "cort"]],
                maxSuggestValues: 10
            };
        },
        getInitialState: function() {
            return {
                codeValue: '',
                titleValue: '',
                suggestValues: []
            };
        },
        updateDesign: function() {
            $.material.init();
        },
        componentDidMount: function() {
            this.updateDesign();
        },
        handleCodeChange: function(value) {
            var newState = {codeValue: value};
            if (value.length == 3) {
                var item = this.props.data.filter(function (dbItem) {
                    return dbItem[0] == value;
                });
                if (item.length > 0) {
                    newState.titleValue = item[0][1];
                }
            }
            this.setState(newState);
        },
        handleTitleChange: function(value) {
            var newState = {titleValue: value};
            if (value.length >= 3) {
                var expression = new RegExp(value, "i");
                var items = this.props.data.filter(function (dbItem) {
                    return expression.test(dbItem);
                });
                if (items.length > 0) {
                    newState.suggestValues = items.slice(0, this.props.maxSuggestValues);
                }
            } else {
                if (this.state.suggestValues.length) {
                    newState.suggestValues = [];
                }
            }
            this.setState(newState);
        },
        handleSuggestSelect: function(suggest) {
            this.setState({
                codeValue: suggest.code,
                titleValue: suggest.title,
                suggestValues: []
            })
        },
        render: function() {
            return (
                <form>
                    <Code onChange={this.handleCodeChange} value={this.state.codeValue} />
                    <Title onChange={this.handleTitleChange} value={this.state.titleValue}>
                        <SuggestList list={this.state.suggestValues} onSelect={this.handleSuggestSelect}/>
                    </Title>
                </form>
            );
        }
    });

    var Suggest = React.createClass({
        onFocus: function () {
            this.props.onSelect({code: this.props.code, title: this.props.title})
        },
        render: function () {
            return (<li onFocus={this.onFocus} ><a href="javascript:void(0)">{this.props.title}</a></li>)
        }
    });

    var SuggestList = React.createClass({
        onSelect: function(suggest) {
            this.props.onSelect(suggest);
        },
        updateDesign: function() {
            $.material.ripples("li");
        },
        getDefaultProps: function() {
            return {
                list: []
            }
        },
        componentDidUpdate: function() {
            this.updateDesign();
        },
        componentDidMount: function() {
            this.updateDesign();
        },
        render: function() {
            if (!this.props.list.length) {
                return false;
            }
            var list = this.props.list.map(function(item){
                return <Suggest key={item[0]}  title={item[1]} code={item[0]} onSelect={this.onSelect} />
            }.bind(this));

            return (<ul className="dropdown-menu">{list}</ul>)
        }
    });

    ReactDOM.render(<SuggestBox data={ds61ItemList} />, document.querySelector('.container'));
</script>
<script type="text/javascript">
//    document.addEventListener("DOMContentLoaded", function () {
//        $.material.init();
//        var db = ds61ItemList;
//        var codeInput = document.querySelector('input[name=code]');
//        var titleInput = document.querySelector('input[name=title]');
//
//        codeInput.addEventListener('keyup', function (e) {
//            var value = e.target.value;
//            if (value.length < 3) {
//                return;
//            }
//            var item = db.filter(function (dbItem) {
//                return dbItem[0] == value;
//            });
//            if (item.length == 0) {
//                return;
//            }
//            $(titleInput).parent().removeClass('is-empty');
//            titleInput.value = item[0][1];
//        });
//        $(titleInput).autocomplete({
//            minLength: 3,
//            source: db,
//            focus: function (event, ui) {
//                $(titleInput).val(ui.item[1]);
//                return false;
//            },
//            select: function (event, ui) {
//                $(titleInput).val(ui.item[1]);
//                $(codeInput).val(ui.item[0]).parent().removeClass('is-empty');
//                return false;
//            },
//            open: function () {
//                $(this).data("uiAutocomplete").menu.element.addClass("dropdown-menu");
//            }
//        }).autocomplete("instance")._renderItem = function (ul, item) {
//            return $("<li>")
//                    .append("<a>" + item[1] + "</a>")
//                    .appendTo(ul);
//        };
//    });
</script>

<!-- Google Analytics -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37094356-4', 'auto');
    ga('send', 'pageview');
</script>
</body>
</html>
